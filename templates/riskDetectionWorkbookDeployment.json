{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Risk Detection Workbook",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the gallery or saved List. Needs to be unique in the scope of the resource group and source"
      }
    },
    "workSpace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of workspace where this workbook will be deployed"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "kind": "shared",
      "apiVersion": "2018-06-17-preview",
      "dependsOn": [],
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Risk Detections (Entra External ID)\\r\\n\\r\\nThis report uses Entra External ID Sign-in logs to capture risk detections and related data. \\r\\nRisk detection is part of the Azure Identity Protection which requires Azure AD Premium P2 license.\\r\\n\\r\\nLearn more about risk detection: [Risk detection and remediation](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection#risk-detection-and-remediation). \\r\\n\\r\\nAccess this and other Entra External ID workbooks on [GitHub](https://github.com/microsoft/external-id-azure-monitor).\\r\\n\\r\\n\",\"style\":\"info\"},\"name\":\"text - 7\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"fe93a9e0-c664-4934-913b-45a85a4e190b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"25\",\"name\":\"parameters - 10\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e4cef524-5572-41a3-928e-11e20b0a1a08\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"FilterBySignInRiskLevel\",\"label\":\"Sign-in Risk\",\"type\":2,\"multiSelect\":true,\"quote\":\"\",\"delimiter\":\",\",\"query\":\"SigninLogs\\n//| where RiskLevelDuringSignIn != \\\"none\\\"\\n| distinct RiskLevelDuringSignIn\\n\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"25\",\"name\":\"parameters - 10 - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"57667de6-2727-43ec-8118-88fd78c131a0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"FilterByCountry\",\"label\":\"Country\",\"type\":2,\"multiSelect\":true,\"quote\":\"\",\"delimiter\":\",\",\"query\":\"SigninLogs\\n| where Location != \\\"\\\"\\n| distinct Location\\n\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"25\",\"name\":\"parameters - 10 - Copy - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"11e980c9-1ea9-4af8-ab25-5212c6c5737e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"FilterByIPAddress\",\"label\":\"Exclude IPs\",\"type\":2,\"multiSelect\":true,\"quote\":\"\",\"delimiter\":\",\",\"query\":\"SigninLogs\\n| where RiskState == \\\"atRisk\\\" \\n| distinct IPAddress\",\"value\":[],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"25\",\"name\":\"parameters - 10\"},{\"type\":1,\"content\":{\"json\":\"<br/><br/>\\n\"},\"name\":\"text - 15\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"71ab978a-c66d-47dc-aa0a-6a1a1b5d4d93\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"overview\",\"style\":\"link\"},{\"id\":\"4ba27946-dc0b-4978-b5d6-97591a3bac6e\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Risky Sign-ins\",\"subTarget\":\"details\",\"style\":\"link\"},{\"id\":\"078a8231-b691-41eb-85f6-bd992de8e57f\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Risky Users\",\"subTarget\":\"riskyusers\",\"style\":\"link\"}]},\"name\":\"links - 5\"},{\"type\":1,\"content\":{\"json\":\"<br/><br/>\\n\\n\"},\"name\":\"text - 15 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nSigninLogs\\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| project TimeGenerated, CorrelationId,  IPAddress, Location, UserDisplayName, RiskEventTypes_V2, RiskEventTypes, RiskDetail, RiskState, IsRisky, RiskLevelAggregated, RiskLevelDuringSignIn, UserId\\n| project RiskLevelDuringSignIn\\n| summarize Total= count() by RiskLevelDuringSignIn\\n\",\"size\":2,\"showAnalytics\":true,\"title\":\"Sign-in risk levels\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"high\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"red\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"low\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"yellow\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"medium\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"orange\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"none\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"green\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"aggregation\":\"Count\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"labelSettings\":[{\"columnId\":\"high\",\"label\":\"High\"},{\"columnId\":\"low\",\"label\":\"Low\"},{\"columnId\":\"medium\",\"label\":\"Medium\"},{\"columnId\":\"none\",\"label\":\"No Risk\"}]},\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"formatter\":1},\"subtitleContent\":{\"columnMatch\":\"RiskLevelDuringSignIn\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"none\",\"representation\":\"success\",\"text\":\"No Risk\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"2\",\"text\":\"Medium\"},{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"3\",\"text\":\"High\"},{\"operator\":\"contains\",\"thresholdValue\":\"low\",\"representation\":\"info\",\"text\":\"Low\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[]}}},\"leftContent\":{\"columnMatch\":\"Total\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":true},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"RiskLevelDuringSignIn\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"none\",\"label\":\"No Risk\"}]}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"showPin\":true,\"name\":\"query - 1 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\r\\n| where RiskLevelDuringSignIn != \\\"none\\\"\\r\\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\r\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\r\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\r\\n| project TimeGenerated, CorrelationId, RiskLevelDuringSignIn,  IPAddress, Location, UserDisplayName, RiskEventTypes_V2, RiskEventTypes, RiskDetail, RiskState, IsRisky, RiskLevelAggregated, UserId\\r\\n| summarize count() by  RiskLevelDuringSignIn, Location\\r\\n\",\"size\":2,\"showAnalytics\":true,\"title\":\"Total sign-in risk events by country\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Location\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"Location\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"yellowOrangeRed\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"showPin\":true,\"name\":\"query - 2\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskState == \\\"atRisk\\\" \\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| extend RiskEvent = tolower(RiskEventTypes_V2)\\n| extend User = tolower(Identity)\\n| extend locationDetailsJSON = parse_json(LocationDetails)\\n| extend Latitude=tostring(locationDetailsJSON.geoCoordinates.latitude), Longitude=tostring(locationDetailsJSON.geoCoordinates.longitude)\\n| extend GeoCoordinatesMapLink = strcat(\\\"https://bing.com/maps/default.aspx?cp=\\\",Latitude,\\\"~\\\",Longitude,\\\"&style=h&lvl=15&sp=\\\",\\\"point.\\\",Latitude,\\\"_\\\",Longitude,\\\"_\\\",User)\\n| project IPAddress, Location, Latitude, Longitude, GeoCoordinatesMapLink, RiskLevelDuringSignIn\\n| summarize Total = count() by IPAddress,Latitude, Longitude, GeoCoordinatesMapLink, RiskLevelDuringSignIn, Location\\n| order by Total desc\\n\",\"size\":2,\"showAnalytics\":true,\"title\":\"Total sign-in risk events by IP address\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"IPAddress\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"View\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"3%\"}},{\"columnMatch\":\"Latitude\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":null,\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"3%\"}},{\"columnMatch\":\"Longitude\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"3%\"}},{\"columnMatch\":\"GeoCoordinatesMapLink\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"View in Bing Maps\",\"customColumnWidthSetting\":\"0.5%\"}},{\"columnMatch\":\"RiskLevelDuringSignIn\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"low\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":null,\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"4%\"}},{\"columnMatch\":\"Location\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Globe\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"1%\"}},{\"columnMatch\":\"Total\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orangeRed\"}},{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"aggregation\":\"Count\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"rowLimit\":10000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"IPAddress\",\"label\":\"IP address\"},{\"columnId\":\"GeoCoordinatesMapLink\",\"label\":\"Map\"},{\"columnId\":\"RiskLevelDuringSignIn\",\"label\":\"Sign-in risk\"},{\"columnId\":\"Location\",\"label\":\"Country\"}]},\"sortBy\":[]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"showPin\":true,\"name\":\"query - 1 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskState == \\\"atRisk\\\" \\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| extend RiskEvent = tolower(RiskEventTypes_V2)\\n| extend locationDetailsJSON = parse_json(LocationDetails)\\n| extend Latitude=tostring(locationDetailsJSON.geoCoordinates.latitude), Longitude=tostring(locationDetailsJSON.geoCoordinates.longitude)\\n| extend User = tolower(Identity)\\n//| project Location, Latitude, Longitude, GeoCoordinatesMapLink, Total, IPAddress\\n| summarize Total = count() by Latitude, Longitude, User, Location, IPAddress\\n| extend GeoCoordinatesMapLink = strcat(\\\"https://bing.com/maps/default.aspx?cp=\\\",Latitude,\\\"~\\\",Longitude,\\\"&style=h&lvl=15&sp=\\\",\\\"point.\\\",Latitude,\\\"_\\\",Longitude,\\\"_\\\",User)\\n| project Location, Latitude, Longitude, GeoCoordinatesMapLink, Total\\n| order by Total desc\\n\\n//| extend Latitude=tostring(locationDetailsJSON.geoCoordinates.latitude), Longitude=tostring(locationDetailsJSON.geoCoordinates.longitude)\\n//| extend GeoCoordinatesLink = strcat(\\\"https://bing.com/maps/default.aspx?cp=\\\",Latitude,\\\"~\\\",Longitude,\\\"&style=h&lvl=15&sp=\\\",\\\"point.\\\",Latitude,\\\"_\\\",Longitude,\\\"_\\\",Identity)\\n//| project TimeGenerated,  RiskEvent,  RiskLevelAggregated, UserId, Identity, IPAddress, Location,  Latitude, Longitude, BingMapLink=GeoCoordinatesLink\",\"size\":2,\"showAnalytics\":true,\"title\":\"Total sign-in risk events by geo coordinates\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"RiskEventTypes\",\"parameterName\":\"RiskEventTypes\",\"parameterType\":1},{\"fieldName\":\"UserDisplayName\",\"parameterName\":\"UserDisplayName\",\"parameterType\":1}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Location\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Globe\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"GeoCoordinatesMapLink\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"View in Bing Maps\"}},{\"columnMatch\":\"Total\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\"}},{\"columnMatch\":\"Count\",\"formatter\":4,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"rowLimit\":10000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"GeoCoordinatesMapLink\",\"label\":\"Map\"}]},\"sortBy\":[]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"showPin\":true,\"name\":\"query - 3 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let getValueByKey = (data: string, key: string) { \\n    let helper = (data: string, key: string) {\\n        let indexStart = indexof(data, key);\\n        let endString = '\\\"';\\n        let sub = substring(data, indexStart + strlen(key) + 11); //removing \\\"value\\\":\\\" 11 is the length\\n        let indexEnd = indexof(sub, endString);\\n        let value = substring(sub, 0, indexEnd);\\n        value;\\n    };\\n    let endString = '\\\"';\\n    let condtion  = data contains key;\\n    iff(condtion, helper(data, key), \\\"N/A\\\");\\n};\\nSigninLogs\\n| where RiskState == \\\"atRisk\\\" \\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| summarize total1 = count() by CorrelationId\\n| join kind=leftouter ( AuditLogs \\n    | extend extIdPolicy = getValueByKey(tostring(AdditionalDetails), \\\"PolicyId\\\")\\n    | where extIdPolicy != \\\"N/A\\\"\\n    | distinct CorrelationId, extIdPolicy) on CorrelationId  \\n| project total1, extIdPolicy, CorrelationId\\n| summarize  policyCount= count(), TotalSum = sum(total1) by extIdPolicy\\n| order by TotalSum\\n\",\"size\":2,\"showAnalytics\":true,\"title\":\"Total sign-in risk events by External ID policy\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"RiskEventTypes\",\"parameterName\":\"RiskEventTypes\",\"parameterType\":1},{\"fieldName\":\"UserDisplayName\",\"parameterName\":\"UserDisplayName\",\"parameterType\":1}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"policyCount\",\"formatter\":5},{\"columnMatch\":\"TotalSum\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orangeRed\"}}],\"rowLimit\":10000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"extIdPolicy\",\"label\":\"External ID Policy Name\"},{\"columnId\":\"TotalSum\",\"label\":\"Total\"}]},\"sortBy\":[],\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"extIdPolicy\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"policyCount\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"yAxis\":[\"TotalSum\"]}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"showPin\":true,\"name\":\"query - 3 - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskState == \\\"atRisk\\\" \\n| where RiskLevelDuringSignIn != \\\"none\\\" \\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| extend RiskEvent = tolower(RiskEventTypes_V2)\\n| summarize Total=count() by RiskEventTypes_V2\\n| order by Total\",\"size\":2,\"showAnalytics\":true,\"title\":\"Total sign-in risk events by risk detections\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportFieldName\":\"RiskEventTypes_V2\",\"exportParameterName\":\"RiskEventTypes_V2Param\",\"exportDefaultValue\":\"\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\"}},{\"columnMatch\":\"Count\",\"formatter\":4,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"rowLimit\":10000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"RiskEventTypes_V2\",\"label\":\"Risk Types\"}]},\"sortBy\":[]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"showPin\":true,\"name\":\"query - 3\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskLevelDuringSignIn != \\\"none\\\"\\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| extend Browser = tostring(DeviceDetail.browser)\\n| where Browser != \\\"\\\"\\n| summarize Total = count() by Browser\\n| order by Total\",\"size\":1,\"showAnalytics\":true,\"title\":\"Risky sign-ins by browser\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportFieldName\":\"RiskEventTypes_V2\",\"exportParameterName\":\"RiskEventTypes_V2Param\",\"exportDefaultValue\":\"\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\"}},{\"columnMatch\":\"Count\",\"formatter\":4,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"sortBy\":[],\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Browser\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Total\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"showPin\":true,\"name\":\"query - 3 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskLevelDuringSignIn != \\\"none\\\"\\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| extend OperatingSystem = tostring(DeviceDetail.operatingSystem)\\n| where OperatingSystem != \\\"\\\"\\n| summarize Total = count() by OperatingSystem\\n| order by Total\",\"size\":1,\"showAnalytics\":true,\"title\":\"Risky sign-ins by operating system\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportFieldName\":\"RiskEventTypes_V2\",\"exportParameterName\":\"RiskEventTypes_V2Param\",\"exportDefaultValue\":\"\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\"}},{\"columnMatch\":\"Count\",\"formatter\":4,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"sortBy\":[],\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Browser\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Total\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"showPin\":true,\"name\":\"query - 3 - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskState == \\\"atRisk\\\" \\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| project TimeGenerated, CorrelationId,  IPAddress, Location, UserDisplayName, RiskEventTypes_V2, RiskEventTypes, RiskDetail, RiskState, IsRisky, RiskLevelAggregated, UserId\\n| summarize count() by bin(TimeGenerated,7d), RiskEventTypes\\n| render timechart   \",\"size\":2,\"title\":\"Risky sign-ins by risk type over time\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"name\":\"query - 7\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskState == \\\"atRisk\\\" \\n| where RiskLevelDuringSignIn != \\\"none\\\" \\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| project RiskEventTypes_V2,RiskLevelDuringSignIn\\n//| summarize Total=count() by RiskEventTypes_V2, RiskLevelDuringSignIn\\n| evaluate pivot(RiskLevelDuringSignIn)\\n//| order by high,medium,low\",\"size\":0,\"title\":\"Total - Risky sign-ins by risk type and risk level\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"RiskEventTypes_V2\",\"exportParameterName\":\"RiskEventTypes_V2Param\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"high\",\"formatter\":8,\"formatOptions\":{\"max\":1,\"palette\":\"red\"}},{\"columnMatch\":\"low\",\"formatter\":8,\"formatOptions\":{\"max\":1,\"palette\":\"yellow\"}},{\"columnMatch\":\"medium\",\"formatter\":8,\"formatOptions\":{\"max\":1,\"palette\":\"orange\",\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[]}}},{\"columnMatch\":\"Total\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orangeRed\"}},{\"columnMatch\":\"RiskEventStr\",\"formatter\":1}],\"rowLimit\":10000,\"filter\":true,\"sortBy\":[{\"itemKey\":\"RiskEventTypes_V2\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"RiskEventTypes_V2\",\"label\":\"Detection type\"},{\"columnId\":\"high\",\"label\":\"High\"},{\"columnId\":\"low\",\"label\":\"Low\"},{\"columnId\":\"medium\",\"label\":\"Medium\"}]},\"sortBy\":[{\"itemKey\":\"RiskEventTypes_V2\",\"sortOrder\":1}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"details\"},\"name\":\"query - 16\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskState == \\\"atRisk\\\" \\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where RiskLevelDuringSignIn in (split('{FilterBySignInRiskLevel}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| extend RiskEventStr = dynamic({RiskEventTypes_V2Param})\\n| extend RiskEventTypes_V2Str = translate('\\\\r\\\\n ','',RiskEventTypes_V2) //Removing space and return characters from the risktypes so matching can be done with the parameter value.\\n| where RiskEventTypes_V2Str == tostring(RiskEventStr)\\n| extend locationDetailsJSON = parse_json(LocationDetails)\\n| extend Latitude=tostring(locationDetailsJSON.geoCoordinates.latitude), Longitude=tostring(locationDetailsJSON.geoCoordinates.longitude)\\n| extend GeoCoordinatesLink = strcat(\\\"https://bing.com/maps/default.aspx?cp=\\\",Latitude,\\\"~\\\",Longitude,\\\"&style=h&lvl=15&sp=\\\",\\\"point.\\\",Latitude,\\\"_\\\",Longitude,\\\"_\\\",Identity)\\n| project TimeGenerated, RiskLevelDuringSignIn,RiskEventStr, UserId, Identity, IPAddress, Location,  Latitude, Longitude, BingMapLink=GeoCoordinatesLink, CorrelationId\\n| order by TimeGenerated desc\\n\",\"size\":0,\"title\":\"Details - Risky sign-ins by risk type and risk level\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"CorrelationId\",\"parameterName\":\"CorrelationIdPrm\",\"parameterType\":1},{\"fieldName\":\"Identity\",\"parameterName\":\"IdentityPrm\",\"parameterType\":1}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6},{\"columnMatch\":\"RiskLevelDuringSignIn\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"red\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"low\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":null,\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"RiskEvent\",\"formatter\":1,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[]}}},{\"columnMatch\":\"Identity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Person\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"IPAddress\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"View\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Location\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Globe\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"BingMapLink\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"View in Bing Maps\",\"linkIsContextBlade\":false}},{\"columnMatch\":\"RiskLevelAggregated\",\"formatter\":5,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"GeoCoordinatesLink\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"View in Bing Maps\"}},{\"columnMatch\":\"Point\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}}],\"rowLimit\":10000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"RiskLevelDuringSignIn\",\"label\":\"SignIn Risk\"},{\"columnId\":\"RiskEventStr\",\"label\":\"Risk Type\"},{\"columnId\":\"BingMapLink\",\"label\":\"Map\"}]},\"sortBy\":[]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"details\"},\"name\":\"Risk Events - Filtered by Risk Event Type\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskLevelAggregated != \\\"none\\\"\\n| where RiskState == \\\"atRisk\\\"\\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| project Identity, UserId, TimeGenerated, UserPrincipalName, RiskLevelAggregated\\n| summarize RiskHistoryTotal = count() by Identity, SignInIdentifier=UserPrincipalName, UserId\\n| order by RiskHistoryTotal\\n//| summarize RiskHistoryTotal = count() by Identity, UserId, SignInIdentifier, RiskLevelAggregated\",\"size\":0,\"showAnalytics\":true,\"title\":\"Risky users\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"UserId\",\"exportParameterName\":\"UserIdParam\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Identity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Person\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"SignInIdentifier\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Mail\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"UserId\",\"formatter\":1},{\"columnMatch\":\"RiskHistoryTotal\",\"formatter\":5},{\"columnMatch\":\"UserPrincipalName\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Mail\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"RiskLevelAggregated\",\"formatter\":5,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}],\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"riskyusers\"},\"showPin\":true,\"name\":\"query - 0\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where RiskLevelAggregated != \\\"none\\\"\\n| where RiskEventTypes_V2 != \\\"[]\\\"\\n| where RiskState == \\\"atRisk\\\"\\n| where UserId == '{UserIdParam}'\\n| where IPAddress !in (split('{FilterByIPAddress}',\\\",\\\"))\\n| where Location in (split('{FilterByCountry}',\\\",\\\")) \\n| extend RiskState=iff(RiskState==\\\"atRisk\\\", \\\"At Risk\\\", \\\"N/A\\\")\\n| extend Browser = tostring(DeviceDetail.browser)\\n| where Browser != \\\"\\\"\\n| extend OS = tostring(DeviceDetail.operatingSystem)\\n| where OS != \\\"\\\"\\n| extend locationDetailsJSON = parse_json(LocationDetails)\\n| extend Latitude=tostring(locationDetailsJSON.geoCoordinates.latitude), Longitude=tostring(locationDetailsJSON.geoCoordinates.longitude)\\n| extend GeoCoordinatesLink = strcat(\\\"https://bing.com/maps/default.aspx?cp=\\\",Latitude,\\\"~\\\",Longitude,\\\"&style=h&lvl=15&sp=\\\",\\\"point.\\\",Latitude,\\\"_\\\",Longitude,\\\"_\\\",Identity)\\n| distinct TimeGenerated,Identity, RiskState, RiskLevelAggregated, RiskLevelDuringSignIn, RiskEventTypes_V2, Location, IPAddress, Latitude, Longitude , GeoCoordinatesLink, Browser,OS, CorrelationId\\n| order by TimeGenerated \\n\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Users' risk detections\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"CorrelationId\",\"parameterName\":\"CorrelationIdPrm\",\"parameterType\":1},{\"fieldName\":\"Identity\",\"parameterName\":\"IdentityPrm\",\"parameterType\":1}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6},{\"columnMatch\":\"Identity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Person\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"RiskState\",\"formatter\":5},{\"columnMatch\":\"RiskLevelAggregated\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"low\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"RiskLevelDuringSignIn\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Location\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Globe\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"IPAddress\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"View\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"GeoCoordinatesLink\",\"formatter\":7,\"formatOptions\":{\"linkColumn\":\"GeoCoordinatesLink\",\"linkTarget\":\"Url\",\"linkLabel\":\"View in Bing Maps\"}},{\"columnMatch\":\"Browser\",\"formatter\":1}],\"rowLimit\":10000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"RiskLevelAggregated\",\"label\":\"User Risk\"},{\"columnId\":\"RiskLevelDuringSignIn\",\"label\":\"SignIn Risk\"},{\"columnId\":\"RiskEventTypes_V2\",\"label\":\"Risk Type\"},{\"columnId\":\"GeoCoordinatesLink\",\"label\":\"Map\"}]}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"riskyusers\"},\"showPin\":true,\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let getValueByKey = (data: string, key: string) { \\n    let helper = (data: string, key: string) {\\n        let indexStart = indexof(data, key);\\n        let endString = '\\\"';\\n        let sub = substring(data, indexStart + strlen(key) + 11); //removing \\\"value\\\":\\\" 11 is the length\\n        let indexEnd = indexof(sub, endString);\\n        let value = substring(sub, 0, indexEnd);\\n        value;\\n    };\\n    let endString = '\\\"';\\n    let condtion  = data contains key;\\n    iff(condtion, helper(data, key), \\\"N/A\\\");\\n};\\nAuditLogs\\n//| extend extIdPolicy = getValueByKey(tostring(AdditionalDetails), \\\"PolicyId\\\")\\n//| extend AppliedCAPolicies= getValueByKey(tostring(AdditionalDetails), \\\"AppliedPolicies\\\")\\n//| where AppliedCAPolicies != \\\"N/A\\\" // and AppliedCAPolicies != \\\"\\\"\\n//| extend AppliedCAPoliciesRefined = trim(\\\",\\\", replace_string(AppliedCAPolicies, \\\", PolicyApplies;\\\", \\\",\\\")) //Replace the keyword \\\", PolicyApplies;\\\" with \\\",\\\" and then remove the last \\\",\\\" by using trim()\\n//| extend AppliedCAPoliciesArr = todynamic(split(AppliedCAPoliciesRefined, \\\";\\\"))\\n//| project ConditionalAccessPolicy=split(AppliedCAPoliciesRefined, ',')\\n| extend Details = case(OperationName has \\\"phone\\\", getValueByKey(tostring(AdditionalDetails), \\\"PhoneNumber\\\"), \\n    OperationName has \\\"sms\\\", getValueByKey(tostring(AdditionalDetails), \\\"PhoneNumber\\\"), \\n    OperationName has \\\"Remediate\\\", getValueByKey(tostring(AdditionalDetails), \\\"CompletedActions\\\"), \\n    OperationName has \\\"Send verification email\\\", getValueByKey(tostring(AdditionalDetails), \\\"EmailAddress\\\"), \\n    OperationName has \\\"Evaluate conditional access policies\\\", trim(\\\",\\\", replace_string(getValueByKey(tostring(AdditionalDetails), \\\"AppliedPolicies\\\"), \\\", PolicyApplies;\\\", \\\",\\\")), ////Replace the keyword \\\", PolicyApplies;\\\" with \\\",\\\" and then remove the last \\\",\\\" by using trim()\\n    \\\"\\\") // Last value is the default case\\n| extend Details = iff(Details ==\\\"\\\", \\\"No additional details\\\", Details)\\n| where CorrelationId == '{CorrelationIdPrm}'\\n| extend Identity = '{IdentityPrm}'\\n| project TimeGenerated, Identity, OperationName, Details,Result, CorrelationId\\n| order by TimeGenerated \\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Risk detection details\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6},{\"columnMatch\":\"Identity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Person\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"OperationName\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Normal\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Details\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"No additional details\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"AllServices\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Result\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"success\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"failure\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"clientError\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"info\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"RiskState\",\"formatter\":5},{\"columnMatch\":\"RiskLevelAggregated\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"low\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"RiskLevelDuringSignIn\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Location\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Globe\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"IPAddress\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"View\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"GeoCoordinatesLink\",\"formatter\":7,\"formatOptions\":{\"linkColumn\":\"GeoCoordinatesLink\",\"linkTarget\":\"Url\",\"linkLabel\":\"View in Bing Maps\"}},{\"columnMatch\":\"Browser\",\"formatter\":1}],\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"riskyusers\"},\"showPin\":true,\"name\":\"query - 0 - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let getValueByKey = (data: string, key: string) { \\n    let helper = (data: string, key: string) {\\n        let indexStart = indexof(data, key);\\n        let endString = '\\\"';\\n        let sub = substring(data, indexStart + strlen(key) + 11); //removing \\\"value\\\":\\\" 11 is the length\\n        let indexEnd = indexof(sub, endString);\\n        let value = substring(sub, 0, indexEnd);\\n        value;\\n    };\\n    let endString = '\\\"';\\n    let condtion  = data contains key;\\n    iff(condtion, helper(data, key), \\\"N/A\\\");\\n};\\nAuditLogs\\n//| extend extIdPolicy = getValueByKey(tostring(AdditionalDetails), \\\"PolicyId\\\")\\n//| extend AppliedCAPolicies= getValueByKey(tostring(AdditionalDetails), \\\"AppliedPolicies\\\")\\n//| where AppliedCAPolicies != \\\"N/A\\\" // and AppliedCAPolicies != \\\"\\\"\\n//| extend AppliedCAPoliciesRefined = trim(\\\",\\\", replace_string(AppliedCAPolicies, \\\", PolicyApplies;\\\", \\\",\\\")) //Replace the keyword \\\", PolicyApplies;\\\" with \\\",\\\" and then remove the last \\\",\\\" by using trim()\\n//| extend AppliedCAPoliciesArr = todynamic(split(AppliedCAPoliciesRefined, \\\";\\\"))\\n//| project ConditionalAccessPolicy=split(AppliedCAPoliciesRefined, ',')\\n| extend Details = case(OperationName has \\\"phone\\\", getValueByKey(tostring(AdditionalDetails), \\\"PhoneNumber\\\"), \\n    OperationName has \\\"sms\\\", getValueByKey(tostring(AdditionalDetails), \\\"PhoneNumber\\\"), \\n    OperationName has \\\"Remediate\\\", getValueByKey(tostring(AdditionalDetails), \\\"CompletedActions\\\"), \\n    OperationName has \\\"Send verification email\\\", getValueByKey(tostring(AdditionalDetails), \\\"EmailAddress\\\"), \\n    OperationName has \\\"Evaluate conditional access policies\\\", trim(\\\",\\\", replace_string(getValueByKey(tostring(AdditionalDetails), \\\"AppliedPolicies\\\"), \\\", PolicyApplies;\\\", \\\",\\\")), ////Replace the keyword \\\", PolicyApplies;\\\" with \\\",\\\" and then remove the last \\\",\\\" by using trim()\\n    \\\"\\\") // Last value is the default case\\n| extend Details = iff(Details ==\\\"\\\", \\\"No additional details\\\", Details)\\n| where CorrelationId == '{CorrelationIdPrm}'\\n| extend Identity = '{IdentityPrm}'\\n| project TimeGenerated, Identity, OperationName, Details,Result, CorrelationId\\n| order by TimeGenerated \\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Risk detection details\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6},{\"columnMatch\":\"Identity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Person\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"OperationName\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Normal\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Details\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"No additional details\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"AllServices\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Result\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"success\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"failure\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"clientError\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"info\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"RiskState\",\"formatter\":5},{\"columnMatch\":\"RiskLevelAggregated\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"low\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"RiskLevelDuringSignIn\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Location\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Globe\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"IPAddress\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"View\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"GeoCoordinatesLink\",\"formatter\":7,\"formatOptions\":{\"linkColumn\":\"GeoCoordinatesLink\",\"linkTarget\":\"Url\",\"linkLabel\":\"View in Bing Maps\"}},{\"columnMatch\":\"Browser\",\"formatter\":1}],\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"details\"},\"showPin\":true,\"name\":\"query - 0 - Copy - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/b0e2eadb-68a3-451b-b8e3-4681b9a8368f/resourceGroups/az-woodgrove-rg/providers/Microsoft.OperationalInsights/workspaces/azb2c-woodgrove-logs\"],\"styleSettings\":{\"spacingStyle\":\"none\"},\"fromTemplateId\":\"community-Workbooks/View Designer/Vertical Overview\"}",
        "version": "1.0",
        "sourceId": "[concat(resourceGroup().id,'/','providers/Microsoft.OperationalInsights/workspaces','/',parameters('workSpace'))]",
        "category": "workbook"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'Microsoft.Insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
}
