{
  "contentVersion": "2.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Conditional Access Workbook",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the gallery or saved List. Needs to be unique in the scope of the resource group and source"
      }
    },
    "workSpace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of workspace where this workbook will be deployed"
      }
    }
  },
  "resources": [
    {
      "name": "a9f52ac8-7a5d-4f86-86b8-092a74410758",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "kind": "shared",
      "apiVersion": "2018-06-17-preview",
      "dependsOn": [],
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": { \"json\": \"## Conditional Access Report\\n-------\\n\" },\n      \"name\": \"text - 2\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"id\": \"a004c359-5130-4023-9993-f830f3a436b4\",\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"value\": { \"durationMs\": 7776000000 },\n            \"typeSettings\": {\n              \"selectableValues\": [\n                { \"durationMs\": 300000 },\n                { \"durationMs\": 900000 },\n                { \"durationMs\": 1800000 },\n                { \"durationMs\": 3600000 },\n                { \"durationMs\": 14400000 },\n                { \"durationMs\": 43200000 },\n                { \"durationMs\": 86400000 },\n                { \"durationMs\": 172800000 },\n                { \"durationMs\": 259200000 },\n                { \"durationMs\": 604800000 },\n                { \"durationMs\": 1209600000 },\n                { \"durationMs\": 2419200000 },\n                { \"durationMs\": 2592000000 },\n                { \"durationMs\": 5184000000 },\n                { \"durationMs\": 7776000000 }\n              ],\n              \"allowCustom\": true\n            },\n            \"timeContext\": { \"durationMs\": 86400000 }\n          }\n        ],\n        \"style\": \"pills\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"parameters - 6\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"\\nSigninLogs\\n| where ConditionalAccessStatus in (\\\"success\\\", \\\"failure\\\")\\n| mv-expand ConditionalAccessPolicies \\n| extend policiesApplied = parse_json(ConditionalAccessPolicies)\\n| extend PolicyId = tostring(policiesApplied.id)\\n| extend ExtIdPolicy = tostring(policiesApplied.displayName)\\n| extend PolicyResult = tostring(policiesApplied.result)\\n| extend EnforcedGrantControls = policiesApplied.enforcedGrantControls\\n| extend ConditionsSatisfied = toint(policiesApplied.conditionsSatisfied)\\n| extend ConditionsNotSatisfied = toint(policiesApplied.conditionsNotSatisfied)\\n| project\\n    CorrelationId,\\n    UserPrincipalName,\\n    PolicyId,\\n    ExtIdPolicy,\\n    PolicyResult,\\n    EnforcedGrantControls,\\n    ConditionsSatisfied,\\n    ConditionsNotSatisfied,\\n    ConditionalAccessStatus,\\n    Location\\n| summarize count() by Location, ExtIdPolicy\",\n              \"size\": 3,\n              \"timeContext\": { \"durationMs\": 7776000000 },\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"map\",\n              \"mapSettings\": {\n                \"locInfo\": \"CountryRegion\",\n                \"locInfoColumn\": \"Location\",\n                \"sizeSettings\": \"count_\",\n                \"sizeAggregation\": \"Sum\",\n                \"labelSettings\": \"Location\",\n                \"legendMetric\": \"count_\",\n                \"legendAggregation\": \"Sum\",\n                \"itemColorSettings\": {\n                  \"nodeColorField\": \"count_\",\n                  \"colorAggregation\": \"Sum\",\n                  \"type\": \"heatmap\",\n                  \"heatmapPalette\": \"greenRed\"\n                }\n              }\n            },\n            \"name\": \"query - 1\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"\\nSigninLogs\\n| where ConditionalAccessStatus in (\\\"success\\\", \\\"failure\\\")\\n| mv-expand ConditionalAccessPolicies \\n| extend policiesApplied = parse_json(ConditionalAccessPolicies)\\n| extend PolicyId = tostring(policiesApplied.id)\\n| extend ExtIdPolicy = tostring(policiesApplied.displayName)\\n| extend PolicyResult = tostring(policiesApplied.result)\\n| extend EnforcedGrantControls = policiesApplied.enforcedGrantControls\\n| extend ConditionsSatisfied = toint(policiesApplied.conditionsSatisfied)\\n| extend ConditionsNotSatisfied = toint(policiesApplied.conditionsNotSatisfied)\\n| project\\n    CorrelationId,\\n    UserPrincipalName,\\n    PolicyId,\\n    ExtIdPolicy,\\n    PolicyResult,\\n    EnforcedGrantControls,\\n    ConditionsSatisfied,\\n    ConditionsNotSatisfied,\\n    ConditionalAccessStatus\\n| summarize count() by ExtIdPolicy\",\n              \"size\": 0,\n              \"title\": \"Conditional Access Evaluations Per External Tenant Policy\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"barchart\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"ExtIdPolicy\",\n                  \"formatter\": 1\n                },\n                \"leftContent\": {\n                  \"columnMatch\": \"count_\",\n                  \"formatter\": 12,\n                  \"formatOptions\": { \"palette\": \"auto\" },\n                  \"numberFormat\": {\n                    \"unit\": 17,\n                    \"options\": {\n                      \"style\": \"decimal\",\n                      \"maximumFractionDigits\": 2,\n                      \"maximumSignificantDigits\": 3\n                    }\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"name\": \"query - 3\"\n          }\n        ]\n      },\n      \"name\": \"group - 6\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"## Conditional Access Evaluations\\n---------------------------------\"\n      },\n      \"name\": \"text - 5\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"\\nSigninLogs\\n| where ConditionalAccessStatus in (\\\"success\\\", \\\"failure\\\")\\n| mv-expand ConditionalAccessPolicies \\n| extend policiesApplied = parse_json(ConditionalAccessPolicies)\\n| extend PolicyId = tostring(policiesApplied.id)\\n| extend ExtIdPolicy = tostring(policiesApplied.displayName)\\n| extend PolicyResult = tostring(policiesApplied.result)\\n| extend EnforcedGrantControls = policiesApplied.enforcedGrantControls\\n| extend ConditionsSatisfied = toint(policiesApplied.conditionsSatisfied)\\n| extend ConditionsNotSatisfied = toint(policiesApplied.conditionsNotSatisfied)\\n| project\\n   TimeGenerated,\\n  CorrelationId,\\n    UserPrincipalName,\\n    PolicyId,\\n    ExtIdPolicy,\\n    PolicyResult,\\n    EnforcedGrantControls,\\n    ConditionsSatisfied,\\n    ConditionsNotSatisfied,\\n    ConditionalAccessStatus,\\n    Location\\n\",\n        \"size\": 1,\n        \"timeContext\": { \"durationMs\": 7776000000 },\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"exportFieldName\": \"CorrelationId\",\n        \"exportParameterName\": \"CorrelationId_\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"ExtIdPolicy\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"colors\",\n                \"thresholdsGrid\": [\n                  {\n                    \"operator\": \"==\",\n                    \"thresholdValue\": \"N/A\",\n                    \"representation\": \"orange\",\n                    \"text\": \"{0}{1}\"\n                  },\n                  {\n                    \"operator\": \"Default\",\n                    \"thresholdValue\": null,\n                    \"representation\": \"green\",\n                    \"text\": \"{0}{1}\"\n                  }\n                ],\n                \"compositeBarSettings\": {\n                  \"labelText\": \"\",\n                  \"columnSettings\": []\n                }\n              }\n            },\n            {\n              \"columnMatch\": \"PolicyResult\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"icons\",\n                \"thresholdsGrid\": [\n                  {\n                    \"operator\": \"!=\",\n                    \"thresholdValue\": \"success\",\n                    \"representation\": \"1\",\n                    \"text\": \"{0}{1}\"\n                  },\n                  {\n                    \"operator\": \"Default\",\n                    \"thresholdValue\": null,\n                    \"representation\": \"success\",\n                    \"text\": \"{0}{1}\"\n                  }\n                ]\n              }\n            }\n          ]\n        },\n        \"sortBy\": []\n      },\n      \"name\": \"query - 2\"\n    },\n    {\n      \"type\": 1,\n      \"content\": { \"json\": \"## Details\\n-------\" },\n      \"name\": \"text - 4\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where CorrelationId == '{CorrelationId_}'\\n| mv-expand ConditionalAccessPolicies \\n| extend policiesApplied = parse_json(ConditionalAccessPolicies)\\n| extend PolicyId = tostring(policiesApplied.id)\\n| extend ExtIdPolicy = tostring(policiesApplied.displayName)\\n| extend PolicyResult = tostring(policiesApplied.result)\\n| extend EnforcedGrantControls = policiesApplied.enforcedGrantControls\\n| extend ConditionsSatisfied = toint(policiesApplied.conditionsSatisfied)\\n| extend ConditionsNotSatisfied = toint(policiesApplied.conditionsNotSatisfied)\\n| project\\n   TimeGenerated,\\n  CorrelationId,\\n    UserPrincipalName,\\n    PolicyId,\\n    ExtIdPolicy,\\n    PolicyResult,\\n    EnforcedGrantControls,\\n    ConditionsSatisfied,\\n    ConditionsNotSatisfied,\\n    ConditionalAccessStatus,\\n    Location\\n\",\n        \"size\": 1,\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"query - 2\"\n    }\n  ],\n  \"isLocked\": false,\n  \"fallbackResourceIds\": [\n    \"/subscriptions/b0e2eadb-68a3-451b-b8e3-4681b9a8368f/resourceGroups/az-woodgrove-rg/providers/Microsoft.OperationalInsights/workspaces/azb2c-woodgrove-logs\"\n  ]\n}",
        "version": "1.0",
        "sourceId": "[concat(resourceGroup().id,'/','providers/Microsoft.OperationalInsights/workspaces','/',parameters('workSpace'))]",
        "category": "workbook"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'Microsoft.Insights/workbooks', 'a9f52ac8-7a5d-4f86-86b8-092a74410758')]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
}
